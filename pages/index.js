import Head from 'next/head'
import { sanityClient } from '../lib/sanity'
import { useState, useEffect } from 'react';

import RecipeList from '../components/RecipeList'
import RecipeListSearch from '../components/RecipeListSearch'

import styles from './index.module.css'

const recipesQuery = `*[_type == "recipe"] | order(_createdAt desc){
  _createdAt,
  _id,
  name,
  slug,
  mainImage,
  favorite
}`;

export default function Home({ recipes }) {

  const [ favoriteFilter, setFavoriteFilter ] = useState();
  const [ search, setSearch] = useState('');
  const [ searchData, setSearchData ] = useState([]);
  const [ pageData, setPageData ] = useState([]);

  const onSearchHandler = event => {
    setSearch(event.target.value);
  }

  const onFavoriteToggle = () => {
    if ( favoriteFilter ) {
      setFavoriteFilter(false) 
    } else {
      setFavoriteFilter(true) 
    }
  }

  useEffect(() => {
    if ( favoriteFilter ) {
      const filteredFavorites = recipes.filter((recipe) => {
        return recipe.favorite === true;
      });
      setPageData(filteredFavorites)

    } else {
      setPageData(recipes)
    }
  }, [recipes, favoriteFilter])

  useEffect(() => {
    if(search !== '') {
      const newSearchData = pageData.filter((recipe) => {
        return Object.values(recipe.name).join('').toLowerCase().includes(search.toLowerCase())
      });
      setSearchData(newSearchData);
    } else {
      setSearchData(pageData);
    }
  }, [search, pageData])

  return (
    <div className={styles.container}>
      <Head>
        <title>Recipes &amp; Groceries</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <h1>Lets cook some recipes</h1>
      <RecipeListSearch search={search} onSearchHandler={onSearchHandler} onFavoriteToggle={onFavoriteToggle} favoriteFilter={favoriteFilter} />
      <RecipeList data={search !== '' ? searchData : pageData} page={'recipes'} />
    </div>
  )
}

// We await this function so that on build time Next.js will prerender this page using these fetched props. 
export async function getStaticProps() {
  const recipes = await sanityClient.fetch(recipesQuery)
  return { props: { recipes } }
}
